events {}

http {
  # SR-14 global rate limit
  limit_req_zone $binary_remote_addr zone=perip:10m rate=100r/m;
  limit_req_status 429;

  upstream voting_upstream {
    server voting_a:8002 max_fails=3 fail_timeout=30s;
    server voting_b:8003 max_fails=3 fail_timeout=30s;
    keepalive 10;
  }

  server {
    listen 80;

    location /healthz { return 200 "ok\n"; }

    # General routes (keep)
    location /registration/ { proxy_pass http://registration:8001; }
    location /voting/       { proxy_pass http://voting_upstream; }
    location /results/      { proxy_pass http://results:8004; }

    # SR-14 throttled exact endpoints (preserve full URI by omitting path)
    location = /registration/ballot/token {
      limit_req zone=perip burst=20 nodelay;
      proxy_pass http://registration:8001;   # ✅ preserve /registration/ballot/token
    }

    location = /voting/ballot/submit {
      limit_req zone=perip burst=20 nodelay;
      proxy_pass http://voting_upstream;     # ✅ preserve /voting/ballot/submit
    }
  }
}
